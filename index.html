<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Amway Network Planner - S∆°n V√µ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root {
    --primary: #007aff;
    --bg: #f2f2f7;
    --card: #ffffff;
    --text: #000000;
    --muted: #8e8e93;
    --safe-top: env(safe-area-inset-top);
    --safe-bottom: env(safe-area-inset-bottom);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0; background: var(--bg); color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    -webkit-font-smoothing: antialiased;
    display: flex; flex-direction: column; min-height: 100vh;
}

.header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: saturate(180%) blur(20px);
    padding: calc(var(--safe-top) + 12px) 16px 12px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 0.5px solid #d1d1d6;
}
.header-title { font-weight: 700; font-size: 17px; }
.header button {
    padding: 6px 12px; border: none; border-radius: 8px;
    background: var(--primary); color: #fff; font-size: 14px; font-weight: 600;
}

.container { padding: 12px; max-width: 480px; margin: 0 auto; flex: 1; width: 100%; }

.node {
    background: var(--card); border-radius: 14px; padding: 16px;
    margin-bottom: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.indent-1 { margin-left: 12px; border-left: 2px solid #d1d1d6; }
.indent-2 { margin-left: 24px; border-left: 2px solid #d1d1d6; }
.indent-3 { margin-left: 36px; border-left: 2px solid #d1d1d6; }

.node-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.toggle {
    width: 26px; height: 26px; display: flex; align-items: center; justify-content: center;
    background: #e9e9eb; border-radius: 50%; color: var(--text); font-weight: 600;
}
.name { font-weight: 600; font-size: 17px; flex: 1; }

.actions button {
    width: 36px; height: 36px; border: none; border-radius: 10px;
    background: #f2f2f7; font-size: 18px; color: var(--primary);
}

.node-info { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.info-box {
    background: #ffffff; padding: 10px; border-radius: 10px; 
    border: 0.5px solid #d1d1d6; cursor: pointer;
}
.info-box:active { background: #f2f2f7; }
.info-box span { font-size: 12px; color: var(--muted); display: block; margin-bottom: 2px; }
.info-box b { font-size: 16px; font-weight: 600; }

.income-trigger { background: #f0f7ff; border-color: #007aff; }
.income-trigger b { color: var(--primary); }

.modal-overlay, .modal-edit {
    position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4);
    display: none; align-items: center; justify-content: center; z-index: 1000;
    padding: 24px; backdrop-filter: blur(4px);
}
.modal-edit.active { display: flex; }

.floating-card, .edit-box {
    background: #fff; width: 100%; max-width: 360px; border-radius: 20px;
    padding: 24px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.field { margin-bottom: 16px; }
.field label { font-size: 13px; font-weight: 600; color: var(--muted); text-transform: uppercase; }
.field input {
    width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #d1d1d6;
    font-size: 17px; margin-top: 6px; background: #f9f9f9;
}

.check-row {
    display: flex; align-items: center; gap: 12px; padding: 12px;
    background: #f2f2f7; border-radius: 12px; font-size: 15px; margin-bottom: 8px;
}
.check-row input { width: 22px; height: 22px; }

.modal-footer { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
.modal-footer button { padding: 14px; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; }

.badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 700; margin-left: 4px; }
.bg-csi { background: #34c759; color: #fff; }
.bg-bf { background: #ffcc00; color: #000; }
.bg-bb { background: #ff9500; color: #fff; }

footer {
    text-align: center; padding: 20px 0 calc(var(--safe-bottom) + 20px);
    color: var(--muted); font-size: 13px; letter-spacing: -0.2px;
}
</style>
</head>

<body>

<div class="header">
    <div class="header-title">Network Planner</div>
    <div style="display:flex; gap:8px">
        <button style="background:#e9e9eb; color:var(--primary)" onclick="exportExcel()">Xu·∫•t</button>
        <button onclick="document.getElementById('importFile').click()">Nh·∫≠p</button>
    </div>
    <input type="file" id="importFile" style="display:none" onchange="importExcel(event)">
</div>

<div class="container" id="tree"></div>

<div id="incomeOverlay" class="modal-overlay" onclick="this.style.display='none'">
    <div class="floating-card" onclick="event.stopPropagation()">
        <h3 id="tipName" style="margin-top:0; font-size:18px"></h3>
        <div id="tipBody"></div>
        <button onclick="document.getElementById('incomeOverlay').style.display='none'" style="width:100%; margin-top:20px; padding:14px; border:none; border-radius:12px; background:var(--primary); color:#fff; font-weight:700">Xong</button>
    </div>
</div>

<div class="modal-edit" id="modal">
    <div class="edit-box">
        <h3 id="modalTitle" style="margin: 0 0 20px; font-size: 19px;"></h3>
        <div class="field"><label>T√™n NPP</label><input id="mName"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <div class="field"><label>PV C√° Nh√¢n</label><input type="number" id="mPV" pattern="\d*"></div>
            <div class="field"><label>PV Kh√°ch</label><input type="number" id="mKH" pattern="\d*"></div>
        </div>
        <div class="check-group">
            <label class="check-row"><input type="checkbox" id="csi"> <span>Th∆∞·ªüng CSI</span></label>
            <label class="check-row"><input type="checkbox" id="bf"> <span>ƒê·ªìng n·ªÅn t·∫£ng (BF)</span></label>
            <label class="check-row"><input type="checkbox" id="bb"> <span>ƒê·ªìng x√¢y d·ª±ng (BB)</span></label>
        </div>
        <div class="modal-footer">
            <button onclick="closeModal()" style="background:#f2f2f7; color:#000">H·ªßy</button>
            <button onclick="saveModal()" style="background:var(--primary); color:#fff">L∆∞u l·∫°i</button>
        </div>
    </div>
</div>

<footer>
    &copy; 2026 Developed by <strong>S∆°n V√µ</strong>
</footer>

<script>
// Logic t√≠nh to√°n v√† ƒëi·ªÅu khi·ªÉn (gi·ªØ nguy√™n b·∫£n t·ªëi ∆∞u tr∆∞·ªõc ƒë√≥)
let id=1, root, mode, editNode, parentAdd;

function percentByGroup(g){
    if(g>=10000)return 21; if(g>=7000)return 15; if(g>=4000)return 12;
    if(g>=1200)return 9; if(g>=600)return 6; if(g>=200)return 3; return 0;
}
function createNode(level, parent) {
    return { id: id++, level, parent, name: "NPP " + id, pv: 0, kh: 0, rewards: { csi: false, bf: false, bb: false }, children: [], expanded: true };
}
function initDefaultTree() {
    id = 0; const r = createNode(0, null); r.name = "NPP 1";
    for (let i = 0; i < 3; i++) r.children.push(createNode(1, r.id));
    return r;
}
root = initDefaultTree();

function compute(node) {
    const ownPV = (node.pv || 0) + (node.kh || 0);
    node.children.forEach(c => compute(c));
    let internalGPV = ownPV;
    node.children.forEach(c => { if (!c.isSplit) internalGPV += c.group; });
    const splitChildren = node.children.filter(c => c.isSplit);
    let totalClusterPotential = internalGPV;
    splitChildren.forEach(c => { totalClusterPotential += c.group; });
    node.isSplit = internalGPV >= 10000 || (splitChildren.length === 1 && internalGPV >= 4000) || (splitChildren.length >= 2) || (totalClusterPotential >= 10000 && splitChildren.length > 0);
    const canReceiveLB = (internalGPV >= 4000 || splitChildren.length >= 2);
    node.group = (node.isSplit && canReceiveLB) ? internalGPV : totalClusterPotential;
    node.percent = node.isSplit ? 21 : percentByGroup(internalGPV);
    let maxChildPercent = 0;
    node.children.forEach(c => { maxChildPercent = Math.max(maxChildPercent, c.percent || 0); });
    node.percent = Math.max(node.percent, maxChildPercent);
    const perfIncome = (ownPV * node.percent / 100 * 26800);
    let diffIncome = 0;
    node.children.forEach(c => { if (!c.isSplit) diffIncome += Math.max(node.percent - c.percent, 0) / 100 * c.group * 26800; });
    let lb = 0;
    if (splitChildren.length > 0 && canReceiveLB) {
        let lbSum = 0; splitChildren.forEach(c => lbSum += Math.max(10000, c.group) * 26800 * 0.06);
        lb = Math.max(lbSum - ((internalGPV >= 10000) ? 0 : (10000 - internalGPV) * 26800 * 0.06), 0);
    }
    let csi = 0, bf = 0, bb = 0;
    if (node.rewards.csi && (node.pv || 0) >= 50 && node.percent <= 9) csi = (10 - node.percent) / 100 * (node.kh || 0) * 26800;
    const baseBronze = perfIncome + diffIncome;
    if (node.rewards.bf && node.percent >= 9 && node.children.filter(c => c.percent >= 3).length >= 3) bf = 0.15 * baseBronze;
    if (node.rewards.bb && node.percent >= 15 && node.children.filter(c => c.percent >= 6).length >= 3) bb = 0.20 * baseBronze;
    node.ownPV = ownPV; node.displayGPV = internalGPV;
    node.breakdown = { direct: perfIncome, diff: diffIncome, csi, bf, bb, lb };
    node.income = Math.round(perfIncome + diffIncome + csi + bf + bb + lb);
}

function render(){ compute(root); tree.innerHTML=""; draw(root); }

function draw(n) {
    const el = document.createElement("div");
    el.className = `node indent-${Math.min(n.level, 3)}`;
    let bHtml = '';
    if (n.rewards.csi) bHtml += '<span class="badge bg-csi">CSI</span>';
    if (n.rewards.bf)  bHtml += '<span class="badge bg-bf">BF</span>';
    if (n.rewards.bb)  bHtml += '<span class="badge bg-bb">BB</span>';

    el.innerHTML = `
    <div class="node-header">
        <div class="toggle" onclick="toggleNode(${n.id})">${n.children.length ? (n.expanded ? "‚àí" : "+") : ""}</div>
        <div class="name" onclick="openEditById(${n.id})" style="${n.percent === 21 ? 'color:var(--primary)' : ''}">${n.name}${bHtml}</div>
        <div class="actions">
            <button onclick="addNode(${n.id})">Ôºã</button>
            ${n !== root ? `<button style="color:#ff3b30" onclick="deleteNode(${n.id})">üóë</button>` : ""}
        </div>
    </div>
    <div class="node-info">
        <div class="info-box" onclick="openEditById(${n.id})"><span>PV C√° nh√¢n</span><b>${n.ownPV}</b></div>
        <div class="info-box" onclick="openEditById(${n.id})"><span>GTƒê Nh√≥m</span><b>${n.displayGPV.toLocaleString()}</b></div>
        <div class="info-box" onclick="openEditById(${n.id})"><span>% HHTT</span><b>${n.percent}%</b></div>
        <div class="info-box income-trigger" onclick="showIncome(${n.id})"><span>Thu nh·∫≠p</span><b>${n.income.toLocaleString()} ƒë</b></div>
    </div>`;
    tree.appendChild(el);
    if (n.expanded) n.children.forEach(draw);
}

function showIncome(nid) {
    const n = find(root, nid);
    document.getElementById('tipName').innerText = n.name;
    document.getElementById('tipBody').innerHTML = `
        <div style="display:flex; justify-content:space-between; margin-bottom:10px"><span>HHTT c√° nh√¢n</span><span>${Math.round(n.breakdown.direct).toLocaleString()}</span></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px"><span>HHTT ch√™nh l·ªách</span><span>${Math.round(n.breakdown.diff).toLocaleString()}</span></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px"><span>CSI</span><span>${Math.round(n.breakdown.csi).toLocaleString()}</span></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px"><span>Th∆∞·ªüng BF</span><span>${Math.round(n.breakdown.bf).toLocaleString()}</span></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px"><span>Th∆∞·ªüng BB</span><span>${Math.round(n.breakdown.bb).toLocaleString()}</span></div>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px"><span>HHLƒê (6%)</span><span>${Math.round(n.breakdown.lb).toLocaleString()}</span></div>
        <div style="display:flex; justify-content:space-between; border-top:0.5px solid #eee; padding-top:10px; font-weight:700; font-size:16px"><span>T·ªïng c·ªông</span><span>${n.income.toLocaleString()} ƒë</span></div>
    `;
    document.getElementById('incomeOverlay').style.display = 'flex';
}
function closeModal(){ modal.classList.remove("active"); }
function toggleNode(nid) { const n = find(root, nid); n.expanded = !n.expanded; render(); }
function openEditById(nid) { openEdit(find(root, nid)); }
function addNode(pid){
    parentAdd=find(root,pid); mode="add"; modalTitle.innerText="Th√™m tuy·∫øn d∆∞·ªõi";
    mName.value=""; mPV.value=0; mKH.value=0; csi.checked=bf.checked=bb.checked=false;
    modal.classList.add("active");
}
function openEdit(n){
    mode="edit"; editNode=n; modalTitle.innerText="Ch·ªânh s·ª≠a NPP";
    mName.value=n.name; mPV.value=n.pv; mKH.value=n.kh;
    csi.checked=n.rewards.csi; bf.checked=n.rewards.bf; bb.checked=n.rewards.bb;
    modal.classList.add("active");
}
function saveModal(){
    if(mode==="add"){
        const n=createNode(parentAdd.level+1,parentAdd.id);
        n.name=mName.value || "NPP"; n.pv=+mPV.value; n.kh=+mKH.value;
        n.rewards={csi:csi.checked,bf:bf.checked,bb:bb.checked};
        parentAdd.children.push(n); parentAdd.expanded=true;
    }else{
        editNode.name=mName.value; editNode.pv=+mPV.value; editNode.kh=+mKH.value;
        editNode.rewards={csi:csi.checked,bf:bf.checked,bb:bb.checked};
    }
    closeModal(); render();
}
function deleteNode(id){ if(confirm("Xo√° NPP n√†y?")) { removeNode(root,id); render(); } }
function removeNode(p,id){ p.children=p.children.filter(c=>c.id!==id); p.children.forEach(c=>removeNode(c,id)); }
function find(n,i){ if(n.id===i)return n; for(const c of n.children){const f=find(c,i);if(f)return f;} }
function exportExcel(){ 
    const rows = [];
    function flatten(node){
        rows.push({id:node.id, parentId:node.parent||0, name:node.name, pv:node.pv, kh:node.kh, csi:node.rewards.csi, bf:node.rewards.bf, bb:node.rewards.bb});
        node.children.forEach(flatten);
    }
    flatten(root);
    const ws = XLSX.utils.json_to_sheet(rows); const wb = XLSX.utils.book_new(); 
    XLSX.utils.book_append_sheet(wb, ws, "Network"); XLSX.writeFile(wb, "amway_plan.xlsx"); 
}
function importExcel(e){
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader(); r.onload = evt=>{
        const d = new Uint8Array(evt.target.result); const wb = XLSX.read(d,{type:"array"});
        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        const map = {}; id = 0;
        data.forEach(r=>{ map[r.id] = { id:r.id, level:0, parent:r.parentId||null, name:r.name, pv:+r.pv||0, kh:+r.kh||0, rewards:{csi:!!r.csi,bf:!!r.bf,bb:!!r.bb}, children:[], expanded:true }; id=Math.max(id,r.id+1); });
        let newRoot = null;
        data.forEach(r=>{ if(!r.parentId) newRoot = map[r.id]; else { map[r.parentId].children.push(map[r.id]); map[r.id].level = map[r.parentId].level+1; } });
        root = newRoot; render();
    }; r.readAsArrayBuffer(f);
}
render();
</script>
</body>
</html>
