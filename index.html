<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Amway Network Planner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#2563eb;--bg:#f8fafc;--card:#ffffff;
  --text:#0f172a;--muted:#64748b;
}
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",
               Roboto,Inter,Helvetica,Arial,sans-serif;
}
.header{
  height:56px;background:var(--card);
  display:flex;align-items:center;gap:12px;
  padding:0 16px;font-weight:600;
  box-shadow:0 1px 3px rgba(0,0,0,.05);
}
.header button{
  padding:6px 12px;border:none;border-radius:999px;
  background:var(--primary);color:#fff;
  cursor:pointer;font-size:13px;
}
.container{max-width:1100px;margin:16px auto;padding:0 12px}
.node{
  background:var(--card);border-radius:14px;
  padding:14px 16px;margin-bottom:12px;
  box-shadow:0 4px 14px rgba(0,0,0,.04);
}
.node-header{display:flex;align-items:center;gap:10px}
.toggle{width:22px;text-align:center;font-weight:600;color:var(--primary);cursor:pointer}
.name{font-weight:600;font-size:15px;cursor:pointer}
.actions{margin-left:auto;display:flex;gap:6px}
.actions button{border:none;background:transparent;font-size:18px;cursor:pointer;opacity:.7}
.node-info{
  margin-left:32px;margin-top:8px;
  display:grid;grid-template-columns:repeat(4,auto);
  gap:20px;font-size:13px;color:var(--muted)
}
.node-info b{color:var(--text)}
.income{cursor:pointer;position:relative}
.tooltip{
  position:absolute;left:0;top:120%;
  background:#fff;border-radius:12px;
  padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.15);
  font-size:13px;display:none;min-width:280px;z-index:20
}
.income:hover .tooltip{display:block}
.tooltip div{display:flex;justify-content:space-between;margin-bottom:4px}
.tooltip hr{border:none;border-top:1px solid #e5e7eb;margin:6px 0}
.indent-0{margin-left:0}.indent-1{margin-left:20px}
.indent-2{margin-left:40px}.indent-3{margin-left:60px}.indent-4{margin-left:80px}

.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;align-items:center;justify-content:center
}
.modal.active{display:flex}
.modal-box{
  background:#fff;width:92%;max-width:380px;
  border-radius:16px;padding:18px
}
.field{margin-bottom:14px}
.field label{font-size:13px;color:var(--muted)}
.field input{width:100%;padding:10px;margin-top:4px}

/* ===== S·ª¨A L·ªñI CHECKBOX L·ªÜCH H√ÄNG ===== */
.rewards {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 10px;
}

.check-row {
  display: flex;
  align-items: center; /* CƒÉn gi·ªØa theo chi·ªÅu d·ªçc */
  gap: 8px;           /* Kho·∫£ng c√°ch gi·ªØa checkbox v√† ch·ªØ */
  cursor: pointer;
}

.check-row input[type="checkbox"] {
  width: 18px;        /* K√≠ch th∆∞·ªõc checkbox v·ª´a v·∫∑n */
  height: 18px;
  margin: 0;          /* X√≥a margin m·∫∑c ƒë·ªãnh g√¢y l·ªách */
  cursor: pointer;
}

.check-row label {
  font-size: 14px;
  color: var(--text);
  cursor: pointer;
  user-select: none;  /* NgƒÉn b√¥i ƒëen ch·ªØ khi click nhanh */
}

.modal-footer{
  display:flex;justify-content:flex-end;gap:10px
}
.modal-footer button{
  padding:10px 18px;border:none;border-radius:999px;cursor:pointer
}
.btn-cancel{background:#e5e7eb}
.btn-save{background:var(--primary);color:#fff}

/* Bi·ªÉu t∆∞·ª£ng b√°o hi·ªáu c·∫°nh t√™n NPP */
.badge-container {
  display: inline-flex;
  gap: 4px;
  margin-left: 8px;
  vertical-align: middle;
}
.badge {
  font-size: 10px;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: bold;
  text-transform: uppercase;
}
.badge-csi { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
.badge-bf { background: #fef9c3; color: #854d0e; border: 1px solid #fef08a; }
.badge-bb { background: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }


</style>
</head>

<body>

<div class="header">
  Amway Network Planner
  <button onclick="exportExcel()">Export Excel</button>
  <button onclick="document.getElementById('importFile').click()">Import Excel</button>
  <input type="file" id="importFile" accept=".xlsx,.xls"
         style="display:none" onchange="importExcel(event)">
</div>

<div class="container" id="tree"></div>

<!-- ===== MODAL ===== -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h3 id="modalTitle"></h3>

    <div class="field">
      <label>T√™n NPP</label>
      <input id="mName">
    </div>

    <div class="field">
      <label>PV c√° nh√¢n</label>
      <input type="number" id="mPV">
    </div>

    <div class="field">
      <label>PV t·ª´ KHNPP</label>
      <input type="number" id="mKH">
    </div>

<div class="field rewards">
  <label class="check-row">
    <input type="checkbox" id="csi">
    <span>CSI</span>
  </label>
  <label class="check-row">
    <input type="checkbox" id="bf">
    <span>Bronze Foundation</span>
  </label>
  <label class="check-row">
    <input type="checkbox" id="bb">
    <span>Bronze Builder</span>
  </label>
</div>

    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">H·ªßy</button>
      <button class="btn-save" onclick="saveModal()">L∆∞u</button>
    </div>
  </div>
</div>

<!-- ===== JS PH·∫¶N LOGIC (GI·ªÆ NGUY√äN B·∫¢N ·ªîN ƒê·ªäNH TR∆Ø·ªöC ƒê√ì) ===== -->
<!-- B·∫°n gi·ªØ nguy√™n ph·∫ßn compute, render, import/export nh∆∞ ƒëang d√πng -->
 <script>
/* ================= IMPORT / EXPORT ================= */

// Flatten tree ‚Üí array
function flattenTree(node, arr=[]){
  arr.push({
    id: node.id,
    parentId: node.parent || 0,
    name: node.name,
    pv: node.pv,
    kh: node.kh,
    csi: node.rewards.csi,
    bf: node.rewards.bf,
    bb: node.rewards.bb
  });
  node.children.forEach(c=>flattenTree(c,arr));
  return arr;
}

function exportExcel(){
  const rows = flattenTree(root);
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Network");
  XLSX.writeFile(wb, "amway_network.xlsx");
}

function importExcel(e){
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = evt=>{
    const data = new Uint8Array(evt.target.result);
    const wb = XLSX.read(data,{type:"array"});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet);

    buildTreeFromRows(rows);
    render();
  };
  reader.readAsArrayBuffer(file);
}

// Build tree (ghi ƒë√® to√†n b·ªô)
function buildTreeFromRows(rows){
  const map = {};
  id = 1;

  rows.forEach(r=>{
    map[r.id] = {
      id: r.id,
      level: 0,
      parent: r.parentId || null,
      name: r.name,
      pv: +r.pv || 0,
      kh: +r.kh || 0,
      rewards:{csi:!!r.csi,bf:!!r.bf,bb:!!r.bb},
      children:[],
      expanded:true
    };
    id = Math.max(id, r.id+1);
  });

  let newRoot = null;
  rows.forEach(r=>{
    if(!r.parentId){
      newRoot = map[r.id];
    }else{
      map[r.parentId].children.push(map[r.id]);
      map[r.id].level = map[r.parentId].level + 1;
    }
  });

  root = newRoot;
}

function percentByGroup(g){
  if(g>=10000)return 21;if(g>=7000)return 15;if(g>=4000)return 12;
  if(g>=1200)return 9;if(g>=600)return 6;if(g>=200)return 3;return 0;
}

// H√†m t·∫°o Node v·ªõi PV m·∫∑c ƒë·ªãnh b·∫±ng 0
function createNode(level, parent) {
  return { 
    id: id++, level, parent, name: "NPP " + id,
    pv: 0, kh: 0, 
    rewards: { csi: false, bf: false, bb: false },
    children: [], expanded: true 
  };
}

// Kh·ªüi t·∫°o c·∫•u tr√∫c: 1 g·ªëc -> 3 con level 1
function initDefaultTree() {
  id = 0;
  const newRoot = createNode(0, null);
  newRoot.name = "NPP 1";
  for (let i = 0; i < 3; i++) {
    newRoot.children.push(createNode(1, newRoot.id));
  }
  return newRoot;
}

root = initDefaultTree();

function compute(node) {
    const ownPV = (node.pv || 0) + (node.kh || 0);
    
    // 1. ƒê·ªá quy t√≠nh to√°n c√°c con tr∆∞·ªõc
    node.children.forEach(child => compute(child));

    // 2. T√≠nh GPV n·ªôi b·ªô (Ch·ªâ g·ªìm c√° nh√¢n + c√°c nh√°nh th·ª±c s·ª± kh√¥ng t√°ch)
    let internalGPV = ownPV;
    node.children.forEach(child => {
        if (!child.isSplit) {
            internalGPV += child.group;
        }
    });

    // 3. X√ÅC ƒê·ªäNH TR·∫†NG TH√ÅI T√ÅCH (isSplit)
    // M·ªôt node ƒë∆∞·ª£c coi l√† t√°ch ƒë·ªëi v·ªõi c·∫•p tr√™n n·∫øu:
    // - GPV n·ªôi b·ªô >= 10k
    // - HO·∫∂C c√≥ con ƒë√£ t√°ch v√† (GPV n·ªôi b·ªô >= 4k)
    // - HO·∫∂C c√≥ t·ª´ 2 con ƒë√£ t√°ch tr·ªü l√™n
    // - HO·∫∂C (QUAN TR·ªåNG): T·ªïng c·ª•m ƒë·ªï l√™n t·ª´ ch√≠nh n√≥ >= 10k (Roll-up)
    
    const splitChildren = node.children.filter(c => c.isSplit);
    let totalClusterPotential = internalGPV;
    splitChildren.forEach(c => { totalClusterPotential += c.group; });

    node.isSplit = 
        internalGPV >= 10000 || 
        (splitChildren.length === 1 && internalGPV >= 4000) || 
        (splitChildren.length >= 2) ||
        (totalClusterPotential >= 10000 && splitChildren.length > 0);

    // 4. ƒêI·ªÄU KI·ªÜN NH·∫¨N HHLƒê (canReceiveLB)
    const canReceiveLB = (internalGPV >= 4000 || splitChildren.length >= 2);

    // 5. LOGIC TRUY·ªÄN GI√Å TR·ªä L√äN C·∫§P TR√äN (node.group)
    if (node.isSplit && canReceiveLB) {
        // N·∫øu ƒë·ªß ƒëi·ªÅu ki·ªán nh·∫≠n HHLƒê: Ng·∫Øt nh√°nh, ch·ªâ truy·ªÅn GPV n·ªôi b·ªô l√™n
        node.group = internalGPV;
    } else {
        // N·∫øu kh√¥ng ƒë·ªß ƒëk nh·∫≠n HHLƒê ho·∫∑c kh√¥ng t√°ch: Truy·ªÅn to√†n b·ªô c·ª•m l√™n (Roll-up)
        node.group = totalClusterPotential;
    }

    // 6. T√çNH % TH√ÄNH T√çCH V√Ä THU NH·∫¨P
    node.percent = node.isSplit ? 21 : percentByGroup(internalGPV);
    let maxChildPercent = 0;
    node.children.forEach(c => { maxChildPercent = Math.max(maxChildPercent, c.percent || 0); });
    node.percent = Math.max(node.percent, maxChildPercent);

    const perfIncome = (ownPV * node.percent / 100 * 26800);
    let diffIncome = 0;
    node.children.forEach(child => {
        if (!child.isSplit) {
            diffIncome += Math.max(node.percent - child.percent, 0) / 100 * child.group * 26800;
        }
    });

    // 7. T√çNH HHLƒê (Ch·ªâ t√≠nh n·∫øu th·ªèa canReceiveLB)
    let leaderBonus = 0;
    if (splitChildren.length > 0 && canReceiveLB) {
        let totalLBFromBelow = 0;
        splitChildren.forEach(child => {
            totalLBFromBelow += Math.max(10000, child.group) * 26800 * 0.06;
        });
        const deduction = (internalGPV >= 10000) ? 0 : (10000 - internalGPV) * 26800 * 0.06;
        leaderBonus = Math.max(totalLBFromBelow - deduction, 0);
    }

    // 8. C√ÅC TH∆Ø·ªûNG PH·ª§ (Kh·ªüi t·∫°o 0 tr√°nh NaN)
    let csi = 0, bf = 0, bb = 0;
    if (node.rewards.csi && (node.pv || 0) >= 50 && node.percent <= 9) {
        csi = (10 - node.percent) / 100 * (node.kh || 0) * 26800;
    }
    const baseBronze = perfIncome + diffIncome;
    if (node.rewards.bf && node.percent >= 9 && node.children.filter(c => c.percent >= 3).length >= 3) {
        bf = 0.15 * baseBronze;
    }
    if (node.rewards.bb && node.percent >= 15 && node.children.filter(c => c.percent >= 6).length >= 3) {
        bb = 0.20 * baseBronze;
    }

    // L∆ØU D·ªÆ LI·ªÜU HI·ªÇN TH·ªä
    node.ownPV = ownPV;
    node.displayGPV = internalGPV;
    node.breakdown = { direct: perfIncome, diff: diffIncome, csi, bf, bb, lb: leaderBonus };
    node.income = Math.round(perfIncome + diffIncome + csi + bf + bb + leaderBonus);
}


/* ===== RENDER / MODAL (GI·ªÆ NGUY√äN) ===== */
function removeNode(parent,id){
  parent.children=parent.children.filter(c=>c.id!==id);
  parent.children.forEach(c=>removeNode(c,id));
}
function render(){compute(root);tree.innerHTML="";draw(root);}
function draw(n) {
  const el = document.createElement("div");
  el.className = `node indent-${n.level}`;
  
  // T·∫°o html cho c√°c bi·ªÉu t∆∞·ª£ng th∆∞·ªüng
  let badgesHtml = '<div class="badge-container">';
  if (n.rewards.csi) badgesHtml += '<span class="badge badge-csi">CSI</span>';
  if (n.rewards.bf)  badgesHtml += '<span class="badge badge-bf">BF</span>';
  if (n.rewards.bb)  badgesHtml += '<span class="badge badge-bb">BB</span>';
  badgesHtml += '</div>';

  el.innerHTML = `
  <div class="node-header">
    <div class="toggle">${n.children.length ? (n.expanded ? "‚àí" : "+") : ""}</div>
    <div class="name">${n.name}</div>
    ${badgesHtml} <div class="actions">
      <button onclick="addNode(${n.id})">Ôºã</button>
      ${n !== root ? `<button onclick="deleteNode(${n.id})">üóë</button>` : ""}
    </div>
  </div>
  <div class="node-info">
    <span>PV: <b>${n.ownPV}</b></span>
    <span>GTƒê nh√≥m: <b>${n.displayGPV.toLocaleString()}</b></span>
    <span>% HHTT: <b>${n.percent}%</b></span>
    <span class="income">Thu nh·∫≠p: <b>${n.income.toLocaleString()} ƒë</b>
      <div class="tooltip">
        <div><span>Tr·ª±c ti·∫øp</span><span>${Math.round(n.breakdown.direct).toLocaleString()}</span></div>
        <div><span>Ch√™nh l·ªách</span><span>${Math.round(n.breakdown.diff).toLocaleString()}</span></div>
        <div><span>CSI</span><span>${Math.round(n.breakdown.csi).toLocaleString()}</span></div>
        <div><span>Bronze Foundation</span><span>${Math.round(n.breakdown.bf).toLocaleString()}</span></div>
        <div><span>Bronze Builder</span><span>${Math.round(n.breakdown.bb).toLocaleString()}</span></div>
        <div><span>Hoa h·ªìng l√£nh ƒë·∫°o</span><span>${Math.round(n.breakdown.lb).toLocaleString()}</span></div>
        <hr><div><b>T·ªïng thu nh·∫≠p</b><b>${n.income.toLocaleString()}</b></div>
      </div>
    </span>
  </div>`;
  
  // C√°c s·ª± ki·ªán gi·ªØ nguy√™n
  el.querySelector(".toggle").onclick = () => { n.expanded = !n.expanded; render(); }
  el.querySelector(".name").onclick = () => openEdit(n);
  tree.appendChild(el);
  if (n.expanded) n.children.forEach(draw);
}

function deleteNode(id){
  if(confirm("Xo√° NPP n√†y v√† to√†n b·ªô tuy·∫øn d∆∞·ªõi?")){
    removeNode(root,id);render();
  }
}
function closeModal(){modal.classList.remove("active")}
function addNode(pid){
  parentAdd=find(root,pid);mode="add";
  modalTitle.innerText="Th√™m NPP tuy·∫øn d∆∞·ªõi";
  mName.value="";mPV.value=0;mKH.value=0;
  csi.checked=bf.checked=bb.checked=false;
  modal.classList.add("active");
}
function openEdit(n){
  mode="edit";editNode=n;
  modalTitle.innerText="Ch·ªânh th√¥ng tin NPP";
  mName.value=n.name;mPV.value=n.pv;mKH.value=n.kh;
  csi.checked=n.rewards.csi;
  bf.checked=n.rewards.bf;
  bb.checked=n.rewards.bb;
  modal.classList.add("active");
}
function saveModal(){
  if(mode==="add"){
    const n=createNode(parentAdd.level+1,parentAdd.id);
    n.name=mName.value;n.pv=+mPV.value;n.kh=+mKH.value;
    n.rewards={csi:csi.checked,bf:bf.checked,bb:bb.checked};
    parentAdd.children.push(n);parentAdd.expanded=true;
  }else{
    editNode.name=mName.value;
    editNode.pv=+mPV.value;
    editNode.kh=+mKH.value;
    editNode.rewards={csi:csi.checked,bf:bf.checked,bb:bb.checked};
  }
  closeModal();render();
}
function find(n,i){
  if(n.id===i)return n;
  for(const c of n.children){const f=find(c,i);if(f)return f;}
}
document.addEventListener("keydown",e=>{
  if(e.key==="Escape"&&modal.classList.contains("active"))closeModal();
  if(e.key==="Enter"&&modal.classList.contains("active"))saveModal();
});
render();

</script>

</body>
</html>
